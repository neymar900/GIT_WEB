<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS Restaurante Familiar</title>

<style>
body{margin:0;background:#f1f5f9;font-family:Arial}
.container{max-width:1100px;margin:auto;padding:20px}
h1{margin:0;font-size:22px}
.sub{color:#555;margin-bottom:10px}
.panel,.box{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px #0001}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{border:1px solid #eee;border-radius:10px;padding:12px;display:flex;justify-content:space-between}
.card .meta{font-size:14px}
.card .price{font-weight:bold;color:#1971c2}
.btn{background:#1971c2;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.sec{background:#ccc;color:#000}
input,select{padding:6px;border-radius:6px;border:1px solid #ccc}
.toast{position:fixed;bottom:20px;right:20px;background:#000;color:#fff;padding:10px;border-radius:8px;display:none}
</style>
</head>

<body>
<div class="container">
    <h1>游꽇 POS - Restaurante Familiar</h1>
    <div class="sub">Registrar ventas r치pido</div>

    <!-- FILTROS -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <input id="search" placeholder="Buscar producto..." />
        <select id="filtrocategoria"><option value="">Todas las categor칤as</option></select>
        <select id="metrica">
            <option value="precio">Ordenar por precio</option>
            <option value="ventas">Mas vendidos</option>
        </select>
        <button id="btnRefrescar" class="btn sec">Actualizar</button>
    </div>

    <!-- PRODUCTOS -->
    <div id="grid" class="grid"></div>

    <!-- REGISTRO RAPIDO -->
    <div class="panel">
        <h3>Registro r치pido</h3>
        <select id="quickSelect"></select>
        <input id="quickQty" type="number" value="1" min="1" style="width:70px" />
        <select id="quickPago">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
        </select>
        <button id="quickSell" class="btn">Vender</button>
    </div>

    <!-- REPORTES -->
    <div class="panel">
        <h3>Reporte</h3>
        <select id="selectDias">
            <option value="7">칔ltimos 7 d칤as</option>
            <option value="30">칔ltimos 30</option>
        </select>
        <div id="reportInfo" style="margin-top:10px;font-size:14px"></div>
        <div id="reportTable"></div>
    </div>

    <!-- CONFIG -->
    <div class="panel">
        <h3>Configuraci칩n API</h3>
        <input id="apiUrl" placeholder="Pega tu API URL" style="width:80%" />
        <button id="guardarApi" class="btn">Guardar</button>
        <button id="probarApi" class="btn sec">Probar</button>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ====================================================================== */
/* TU API URL (pegada autom치ticamente) */
let API_URL = "https://script.google.com/macros/s/AKfycbxR8Dvyb-Bcg0MvKve7M-BH4HuBLFLeFvgOdegevieAs3zf-7c-nMeRqt7QDqGbiM3Syg/exec";
/* ====================================================================== */

const $ = id => document.getElementById(id);
let MENU=[], REPORT={};

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

/* ================== CARGAR MENU ================== */
async function loadMenu(){
  if(!API_URL) return;
  try{
    const r = await fetch(API_URL + "?action=menu");
    MENU = await r.json();
    renderMenu();
    loadQuick();
    loadCats();
  }catch(e){ console.error(e); toast("Error cargando men칰"); }
}

/* ================== RENDER MENU ================== */
function renderMenu(){
  const q = $("search").value.toLowerCase();
  const cat = $("filtrocategoria").value;
  const m = MENU.filter(i=>{
    if(cat && i.categoria!==cat) return false;
    if(q && !i.nombre.toLowerCase().includes(q)) return false;
    return true;
  });
  $("grid").innerHTML = m.map(i=>`
    <div class="card">
      <div>
        <div><b>${i.nombre}</b></div>
        <div class="price">S/. ${Number(i.precio).toFixed(2)}</div>
      </div>
      <div>
        Cant: <input id="qty_${i.id}" type="number" value="1" min="1" style="width:60px" />
        <button class="btn" onclick="sell(${i.id})">Vender</button>
      </div>
    </div>`).join("");
}

/* ================== CARGAR DESPLEGABLES ================== */
function loadQuick(){
  $("quickSelect").innerHTML = MENU.map(i =>
    `<option value="${i.id}">${i.nombre} - S/. ${Number(i.precio).toFixed(2)}</option>`
  ).join("");
}
function loadCats(){
  const cats = [...new Set(MENU.map(i=>i.categoria))];
  $("filtrocategoria").innerHTML = `<option value="">Todas</option>`+
    cats.map(c=>`<option>${c}</option>`).join("");
}

/* ================== REGISTRAR VENTA ================== */
async function sell(id){
  const item = MENU.find(i=>i.id==id);
  const qty = Number($("qty_"+id).value);
  await sendSale(item,qty);
}
document.getElementById("quickSell").addEventListener("click", async ()=>{
  const id = $("quickSelect").value;
  const qty = Number($("quickQty").value);
  const item = MENU.find(i=>i.id==id);
  await sendSale(item, qty, $("quickPago").value);
});

async function sendSale(item, qty, pago="efectivo"){
  if(!API_URL) return toast("Configura API");
  if(!item) return toast("Producto no encontrado");
  const data = {
    action:"registrar_venta",
    producto_id:item.id,
    producto_nombre:item.nombre,
    cantidad:qty,
    precio_unitario:item.precio,
    total: Number(item.precio) * Number(qty),
    pago:pago
  };
  try{
    const r = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    const j = await r.json();
    if(j.ok){ toast("Venta registrada"); updateReport(); }
    else{ toast("Error venta"); console.error(j); }
  }catch(e){ console.error(e); toast("Error API"); }
}

/* ================== REPORTES ================== */
async function updateReport(){
  if(!API_URL) return;
  const dias = $("selectDias").value;
  try{
    const r = await fetch(API_URL + "?action=reporte&dias=" + dias);
    const data = await r.json();
    REPORT = data;
    const totalVend = (data.items || []).reduce((a,b)=>a + (b.cantidad||0), 0);
    $("reportInfo").textContent =
      "Ingresos: S/. " + (data.ingresos_totales||0).toFixed(2) + " | Productos vendidos: " + totalVend;
    $("reportTable").innerHTML = "<ul>"+
      (data.items || []).map(i=>`<li>${i.nombre}: ${i.cantidad} (S/. ${Number(i.total).toFixed(2)})</li>`).join("")
      +"</ul>";
  }catch(e){ console.error(e); toast("Error reporte"); }
}

/* ================== CONFIGURACI칍N API ================== */
document.getElementById("guardarApi").addEventListener("click",()=>{
  const v=$("apiUrl").value.trim();
  if(!v) return toast("Pega la URL");
  API_URL=v;
  localStorage.setItem("api_url_rest",v);
  toast("Guardado");
  loadMenu();
  updateReport();
});

document.getElementById("probarApi").addEventListener("click",async()=>{
  try{
    const r=await fetch(API_URL+"?action=menu");
    if(r.ok) toast("API OK"); else toast("API sin respuesta");
  }catch(e){ console.error(e); toast("Error conexi칩n"); }
});

/* ================== EVENTOS ================== */
document.getElementById("search").addEventListener("input",renderMenu);
document.getElementById("filtrocategoria").addEventListener("change",renderMenu);
document.getElementById("btnRefrescar").addEventListener("click",()=>{loadMenu();updateReport();});
document.getElementById("selectDias").addEventListener("change",updateReport);

/* ================== CARGA INICIAL ================== */
(function init(){
  const saved = localStorage.getItem("api_url_rest");
  if(saved){ API_URL=saved; $("apiUrl").value=saved; }
  loadMenu();
  updateReport();
})();
</script>

</body>
</html>
