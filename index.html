<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS - Restaurante Familiar</title>

<style>
:root{
  --accent: #e85a13;
  --muted:#6b7280;
  --card:#ffffff;
  --bg:#f3f6f8;
}

/* Base */
html,body{height:100%;margin:0}
body{
  font-family: "Inter", "Segoe UI", Arial, sans-serif;
  background:
    linear-gradient(rgba(255,255,255,.92), rgba(255,255,255,.92)),
    url("Imagenes/fondoWEB.avif");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  color:#111;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.container{
  max-width:1180px;
  margin:28px auto;
  padding:0 14px;
}

/* Header */
.header{
  display:flex;
  align-items:flex-end;
  gap:16px;
  margin-bottom:18px;
}
.brand{ color:var(--accent); font-weight:800; font-size:24px; display:flex; gap:10px; align-items:center }
.sub{ color:var(--muted); font-size:14px }

/* Panel (filters) */
.panel{
  background: rgba(255,255,255,0.96);
  padding:12px 14px;
  border-radius:14px;
  box-shadow: 0 10px 26px rgba(16,24,40,0.06);
  margin-bottom:18px;
}

.controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.controls input[type="text"]{ padding:10px 12px; border-radius:10px; border:1px solid #e6e9ee; min-width:240px; }
.controls select{ padding:9px 10px; border-radius:10px; border:1px solid #e6e9ee; }
.controls button{ padding:9px 12px; border-radius:10px; border:0; cursor:pointer; }

/* Grid cards */
.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:18px; margin-bottom:18px; }
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  box-shadow: 0 6px 18px rgba(16,24,40,0.06);
  transition: transform .12s, box-shadow .12s;
  display:flex; flex-direction:column; gap:8px;
}
.card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(16,24,40,0.10); }

.card img{
  width:100%;
  height:140px;
  border-radius:8px;
  object-fit:cover;
  background:#fafafa;
  border:1px solid #f0f0f0;
}

.card .title{ font-weight:700; font-size:16px; color:#111 }
.card .cat{ display:inline-block; background:#fff5ef; color:var(--accent); padding:6px 8px; border-radius:999px; font-size:12px; margin-top:4px }
.card .price{ font-weight:800; color:var(--accent); font-size:18px; margin-top:8px }

/* actions */
.row{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; }
.row .left{ display:flex; gap:8px; align-items:center; }
.row input[type="number"]{ width:80px; padding:8px; border-radius:8px; border:1px solid #e6e9ee; }
.btn{ background:var(--accent); color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-weight:700 }
.btn.sec{ background:#cfd6df; color:#111 }

/* panels below */
.panel-large{ background:rgba(255,255,255,0.96); padding:18px; border-radius:12px; box-shadow:0 10px 26px rgba(16,24,40,0.06); margin-bottom:18px; }

/* toast */
.toast{ position:fixed; right:18px; bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:9999 }

/* hidden small config button */
.config-row { display:flex; justify-content:flex-end; margin-bottom:12px; gap:8px; align-items:center; }

/* responsive */
@media (max-width:720px){
  .card img{ height:100px }
  .controls input[type="text"]{ min-width:140px }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">üçΩ POS ‚Äì Restaurante Familiar</div>
    <div style="flex:1"></div>
    <div class="sub">Sistema de ventas r√°pido y simple</div>
  </div>

  <!-- BOT√ìN CONFIG (visible) -->
  <div class="config-row">
    <button id="btnConfig" class="btn sec">‚öô Configuraci√≥n</button>
  </div>

  <!-- filtros -->
  <div class="panel">
    <div class="controls">
      <input id="search" type="text" placeholder="Buscar producto..." />
      <select id="filtrocategoria"><option value="">Todas</option></select>
      <select id="metrica">
        <option value="precio">Ordenar por precio</option>
        <option value="nombre">Ordenar por nombre</option>
      </select>
      <button id="btnRefrescar" class="btn sec">Actualizar</button>
    </div>
  </div>

  <!-- grid de productos -->
  <div id="grid" class="grid"></div>

  <!-- registro rapido -->
  <div class="panel-large">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <select id="quickSelect" style="min-width:260px;padding:10px;border-radius:8px;border:1px solid #e6e9ee"></select>
      <input id="quickQty" type="number" value="1" min="1" style="width:90px;padding:8px;border-radius:8px;border:1px solid #e6e9ee" />
      <select id="quickPago" style="padding:8px;border-radius:8px;border:1px solid #e6e9ee">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
      </select>
      <button id="quickSell" class="btn">Vender</button>
    </div>
  </div>

  <!-- reporte -->
  <div class="panel-large">
    <h3 style="margin:0 0 10px 0">Reporte</h3>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <select id="selectDias" style="padding:8px;border-radius:8px;border:1px solid #e6e9ee">
        <option value="7">√öltimos 7 d√≠as</option>
        <option value="30">√öltimos 30 d√≠as</option>
      </select>
      <div id="reportInfo" style="font-weight:700;color:var(--accent)"></div>
    </div>
    <div id="reportTable" style="margin-top:10px"></div>
  </div>

  <!-- CONFIG API OCULTO (inicio oculto) -->
  <div id="configPanel" class="panel-large" style="display:none">
    <h3 style="margin-top:0">Configuraci√≥n API</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="apiUrl" placeholder="Pega tu URL de Apps Script" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ee" />
      <button id="guardarApi" class="btn">Guardar</button>
      <button id="probarApi" class="btn sec">Probar</button>
    </div>
    <div style="margin-top:10px;color:var(--muted);font-size:13px">
      Guardada en este navegador. Si cambias de equipo pega la URL de nuevo.
    </div>
  </div>
  <!-- CONFIG API OCULTO (fin) -->

</div>

<div id="toast" class="toast"></div>

<script>
/* ================== HELPERS / CONFIG ================== */
const $ = id => document.getElementById(id);
let API_URL = localStorage.getItem('api_url_rest') || '';
let MENU = [];

/* IMAGE MAP (fallback mapping si no viene campo imagen) */
const IMAGE_MAP = {
  "chicharron":"chicharron.jpg",
  "escabeche":"escabeche.jpg",
  "chorizo":"chorizo.jpg",
  "fricase":"fricase.webp",
  "chichadoble":"chicha.jpg",
  "chichalata":"chicha.jpg",
  "chichabalde":"chicha.jpg",
  "chichaalojadoble":"chichaMorada.webp",
  "chichaalojalata":"chichaMorada.webp",
  "chichaalojabalde":"chichaMorada.webp",
  "cervezaunidad":"cerveza.jpg",
  "refresco2l":"Refresco2L.webp",
  "refresco3l":"3L.webp"
};

function norm(s){
  if(!s) return "";
  return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}
function toast(msg){
  const t = $('toast'); t.textContent = msg; t.style.display='block';
  setTimeout(()=> t.style.display='none', 2500);
}

/* ================== CARGAR MENU DESDE API ================== */
async function loadMenu(){
  if(!API_URL) return;
  try{
    const res = await fetch(API_URL + '?action=menu');
    const data = await res.json();
    MENU = (data || []).map(it => {
      const precio = it.precio ?? it.precio_venta ?? it.price ?? 0;
      return {
        id: it.id,
        nombre: it.nombre,
        precio: Number(precio),
        categoria: it.categoria || it.category || '',
        imagen: it.imagen || it.image || ''
      };
    });
    loadCats();
    loadQuick();
    renderMenu();
    updateReport();
  }catch(err){
    console.error('loadMenu', err);
    toast('No se pudo cargar men√∫ (revisa API_URL)');
  }
}

/* ================== RENDER / IMAGEN ================== */
function imageFor(item){
  if(item.imagen && item.imagen.trim() !== '') return `Imagenes/${item.imagen}`;
  const k = norm(item.nombre);
  if(IMAGE_MAP[k]) return `Imagenes/${IMAGE_MAP[k]}`;
  return 'Imagenes/fondoWEB.avif';
}

function renderMenu(){
  const q = ($('search').value || '').toLowerCase();
  const cat = $('filtrocategoria').value || '';
  const met = $('metrica').value || 'precio';

  let lista = MENU.slice();
  if(q) lista = lista.filter(i => (i.nombre||'').toLowerCase().includes(q));
  if(cat) lista = lista.filter(i => i.categoria === cat);

  if(met === 'precio') lista.sort((a,b)=> a.precio - b.precio);
  if(met === 'nombre') lista.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre));

  const html = lista.map(i => `
    <div class="card" id="card_${i.id}">
      <img src="${imageFor(i)}" alt="${i.nombre}" onerror="this.onerror=null;this.src='Imagenes/fondoWEB.avif'">
      <div class="title">${i.nombre}</div>
      <div class="cat">${i.categoria || ''}</div>
      <div class="price">Bs ${Number(i.precio).toFixed(2)}</div>
      <div class="row">
        <div class="left">
          <input id="qty_${i.id}" type="number" value="1" min="1">
        </div>
        <div>
          <button class="btn" onclick="sell(${i.id})">Vender</button>
        </div>
      </div>
    </div>
  `).join('');
  $('grid').innerHTML = html;
}

/* ================== SELECTS ================== */
function loadCats(){
  const cats = [...new Set(MENU.map(i=>i.categoria).filter(Boolean))];
  $('filtrocategoria').innerHTML = `<option value="">Todas</option>` + cats.map(c=>`<option>${c}</option>`).join('');
}

function loadQuick(){
  $('quickSelect').innerHTML = MENU.map(i=>`<option value="${i.id}">${i.nombre} - Bs ${i.precio}</option>`).join('');
}

/* ================== VENTAS ================== */
async function sell(id){
  const item = MENU.find(x=>String(x.id)===String(id));
  if(!item) return toast('Producto no encontrado');
  const qty = Number($('qty_'+id).value || 1);
  await sendSale(item, qty);
}

async function sendSale(item, qty, pago='efectivo'){
  if(!API_URL) return toast('API no configurada');
  const form = new URLSearchParams();
  form.append('action','registrar_venta');
  form.append('producto_id', item.id);
  form.append('producto_nombre', item.nombre);
  form.append('cantidad', qty);
  form.append('precio_unitario', item.precio);
  form.append('total', (item.precio * qty));
  form.append('pago', pago);

  try{
    const r = await fetch(API_URL, {
      method:'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: form.toString()
    });
    const j = await r.json();
    if(j.ok || j === '') {
      toast('Venta registrada');
      updateReport();
    } else {
      console.error('API resp', j);
      toast('Error registrando venta');
    }
  }catch(err){
    console.error('sendSale', err);
    toast('No se pudo conectar con API');
  }
}

/* ================== REPORTE ================== */
async function updateReport(){
  if(!API_URL) return;
  try{
    const dias = $('selectDias').value || 7;
    const r = await fetch(API_URL + `?action=reporte&dias=${dias}`);
    const data = await r.json();
    $('reportInfo').textContent = `Ingresos: Bs ${Number(data.ingresos_totales||0).toFixed(2)}`;
    $('reportTable').innerHTML = '<ul>' + (data.items||[]).map(it=>`<li>${it.nombre}: ${it.cantidad} (Bs ${Number(it.total||0).toFixed(2)})</li>`).join('') + '</ul>';
  }catch(err){
    console.error('updateReport', err);
    $('reportInfo').textContent = 'Sin datos';
  }
}

/* ================== EVENTOS ================== */
$('search')?.addEventListener('input', renderMenu);
$('filtrocategoria')?.addEventListener('change', renderMenu);
$('metrica')?.addEventListener('change', renderMenu);
$('btnRefrescar')?.addEventListener('click', renderMenu);

$('guardarApi')?.addEventListener('click', ()=>{
  const v = $('apiUrl').value.trim();
  if(!v) return toast('Pega la URL de tu Apps Script');
  API_URL = v;
  localStorage.setItem('api_url_rest', v);
  toast('API guardada');
  loadMenu();
});

$('probarApi')?.addEventListener('click', async ()=>{
  try{
    const r = await fetch(API_URL + '?action=menu');
    toast(r.ok ? 'API OK' : 'API sin respuesta');
  }catch(e){
    console.error(e);
    toast('Error prueba API');
  }
});

$('quickSell')?.addEventListener('click', async ()=>{
  const id = $('quickSelect').value;
  const qty = Number($('quickQty').value || 1);
  const pago = $('quickPago').value || 'efectivo';
  const item = MENU.find(x=>String(x.id)===String(id));
  await sendSale(item, qty, pago);
});

$('selectDias')?.addEventListener('change', updateReport);

/* ================== CONFIG PANEL TOGGLE ================== */
const btnConfig = $('btnConfig');
const configPanel = $('configPanel');
btnConfig?.addEventListener('click', ()=>{
  if(!configPanel) return;
  configPanel.style.display = configPanel.style.display === 'block' ? 'none' : 'block';
});

/* init */
(function init(){
  if($('apiUrl')) $('apiUrl').value = API_URL;
  if(API_URL) loadMenu();
})();
</script>
</body>
</html>
