<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS Restaurante Familiar</title>

<style>
:root{
  --primario:#e8590c;
  --secundario:#495057;
  --fondo:#f8f9fa;
  --card:#ffffff;
}

/* Fondo con la imagen */
html,body{
  height:100%;
  margin:0;
}
body{
  background-color:var(--fondo);
  background-image: url('Imagenes/fondoWEB.avif');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  font-family:'Segoe UI',Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* panel central con overlay para legibilidad */
.container{
  max-width:1200px;
  margin:auto;
  padding:28px;
  backdrop-filter: blur(4px);
}

/* titulos */
h1{ margin:0; font-size:26px; color:var(--primario); text-shadow:0 1px 0 rgba(255,255,255,.2); }
.sub{ color:#3338; margin-bottom:12px }

/* tarjetas y grid */
.panel{ background:rgba(255,255,255,0.95); padding:16px; border-radius:14px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px; margin-bottom:16px; }

/* cada card ahora tiene imagen */
.card{
  display:flex;
  gap:12px;
  align-items:center;
  background: #fff;
  border-radius:12px;
  padding:12px;
  box-shadow: 0 4px 14px rgba(0,0,0,.06);
  transition: transform .12s, box-shadow .12s;
}
.card:hover{ transform: translateY(-4px); box-shadow:0 12px 28px rgba(0,0,0,.12); }

.card img{
  width:96px;
  height:80px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid #eee;
  flex-shrink:0;
}

.card .info{ flex:1; }
.card .info b{ display:block; font-size:16px; margin-bottom:4px; color:#222; }
.card .info .badge{ display:inline-block; background:#fff3e0; color:#c2410c; font-size:12px; padding:4px 8px; border-radius:999px; margin-bottom:6px; }
.price{ font-size:18px; font-weight:700; color:var(--primario); margin-top:6px; }

/* controles de venta a la derecha */
.card .actions{ text-align:right; min-width:120px; }
.card input[type="number"]{ width:72px; padding:8px; border-radius:8px; border:1px solid #ddd; }

/* botones */
.btn{ background:var(--primario); color:#fff; border:0; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
.btn.sec{ background:#c7c7c7; color:#111; }

/* inputs y selects */
input,select{ padding:8px 10px; border-radius:10px; border:1px solid #ddd; font-size:14px; }

/* toast */
.toast{ position:fixed; bottom:20px; right:20px; background:#111; color:#fff; padding:11px 14px; border-radius:10px; display:none; box-shadow:0 10px 30px rgba(0,0,0,.3); z-index:9999; }

/* responsive */
@media (max-width:720px){
  .card img{ width:78px; height:60px; }
  .grid{ grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
  h1{ font-size:22px }
}
</style>
</head>
<body>
<div class="container">
  <h1>üçΩ POS ‚Äì Restaurante Familiar</h1>
  <div class="sub">Sistema de ventas ‚Äî con im√°genes</div>

  <!-- FILTROS -->
  <div class="panel" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <input id="search" placeholder="Buscar producto..." style="flex:1;min-width:180px" />
    <select id="filtrocategoria"><option value="">Todas las categor√≠as</option></select>
    <select id="metrica">
      <option value="precio">Ordenar por precio</option>
      <option value="nombre">Ordenar por nombre</option>
    </select>
    <button id="btnRefrescar" class="btn sec">Actualizar</button>
  </div>

  <!-- GRID productos -->
  <div id="grid" class="grid"></div>

  <!-- REGISTRO RAPIDO -->
  <div class="panel" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <select id="quickSelect" style="min-width:220px"></select>
    <input id="quickQty" type="number" value="1" min="1" style="width:82px" />
    <select id="quickPago">
      <option value="efectivo">Efectivo</option>
      <option value="tarjeta">Tarjeta</option>
    </select>
    <button id="quickSell" class="btn">Vender</button>
  </div>

  <!-- REPORTE -->
  <div class="panel">
    <h3>Reporte</h3>
    <select id="selectDias">
      <option value="7">√öltimos 7 d√≠as</option>
      <option value="30">√öltimos 30 d√≠as</option>
    </select>
    <div id="reportInfo" style="margin-top:8px"></div>
    <div id="reportTable" style="margin-top:8px"></div>
  </div>

  <!-- CONFIG -->
  <div class="panel">
    <h3>Configuraci√≥n API</h3>
    <input id="apiUrl" style="width:75%" />
    <button id="guardarApi" class="btn">Guardar</button>
    <button id="probarApi" class="btn sec">Probar</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const $ = id => document.getElementById(id);
let API_URL = localStorage.getItem("api_url_rest") || "";
let MENU = [];

/* ------------------ MAPEOS DE IMAGENES (si no tienes columna imagen) ------------------
   Ajusta o a√±ade aqu√≠ nuevas correspondencias 'nombre_normalizado':'archivo.ext'
   Ej: 'chichaaloja':'chichaMorada.webp'
--------------------------------------------------------------------------------------*/
const IMAGE_MAP = {
  "chicharron":"chicharron.webp",            // si agregas el archivo, pon nombre real
  "escabeche":"escabeche.jpg",
  "chorizo":"chorizo.jpg",
  "fricase":"fricase.webp",
  "chichadoble":"chicha.jpg",
  "chichalata":"chicha.jpg",
  "chichabalde":"chicha.jpg",
  "chichaalojadoble":"chichaMorada.webp",
  "chichaalojalata":"chichaMorada.webp",
  "chichaalojabalde":"chichaMorada.webp",
  "cervezaund":"cerveza.jpg",
  "cervezaunidad":"cerveza.jpg",
  "refresco2l":"Refresco2L.webp",
  "refresco3l":"3L.webp"
};

/* -------------- utilidad: normalizar texto para b√∫squeda de imagen -------------- */
function normName(s){
  if(!s) return "";
  return s.toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // quitar tildes
    .replace(/[^a-z0-9]/g,''); // quitar espacios y caracteres
}

/* ----------------- obtener ruta de imagen para el producto ----------------- */
function imageForItem(item){
  // 1) si el objeto ya trae 'imagen' (recomendado)
  if(item.imagen && item.imagen.trim()!==""){
    return `Imagenes/${item.imagen}`;
  }
  // 2) intentar mapear por nombre normalizado usando IMAGE_MAP
  const key = normName(item.nombre);
  if(IMAGE_MAP[key]) return `Imagenes/${IMAGE_MAP[key]}`;

  // 3) fallback (imagen generica o fondo)
  return `Imagenes/fondoWEB.avif`;
}

/* -------------------- funciones core -------------------- */
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display = "none", 3000);
}

async function loadMenu(){
  if(!API_URL) return;
  try{
    const res = await fetch(API_URL + "?action=menu");
    MENU = await res.json();
    // si el menu desde Google Sheets trae encabezado 'imagen', mantenerlo
    loadCats();
    loadQuick();
    renderMenu();
  }catch(err){
    console.error(err);
    toast("Error cargando men√∫");
  }
}

function renderMenu(){
  let list = [...MENU];
  const q = ($("search").value || "").toLowerCase();
  const cat = $("filtrocategoria").value;
  const met = $("metrica").value;

  if(q) list = list.filter(i => (i.nombre||"").toLowerCase().includes(q));
  if(cat) list = list.filter(i => i.categoria === cat);

  if(met === "precio") list.sort((a,b)=>a.precio - b.precio);
  if(met === "nombre") list.sort((a,b)=> (a.nombre||"").localeCompare(b.nombre));

  $("grid").innerHTML = list.map(i => {
    const img = imageForItem(i);
    return `
      <div class="card">
        <img src="${img}" alt="${i.nombre}" onerror="this.onerror=null;this.src='Imagenes/fondoWEB.avif'"/>
        <div class="info">
          <b>${i.nombre}</b>
          <div class="badge">${i.categoria || ''}</div>
          <div class="price">Bs ${Number(i.precio).toFixed(2)}</div>
        </div>
        <div class="actions">
          <input id="q_${i.id}" type="number" value="1" min="1"><br>
          <button class="btn" onclick="sell(${i.id})">Vender</button>
        </div>
      </div>
    `;
  }).join("");
}

function loadCats(){
  const cats = [...new Set(MENU.map(i=>i.categoria).filter(Boolean))];
  $("filtrocategoria").innerHTML = `<option value="">Todas</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join("");
}

function loadQuick(){
  $("quickSelect").innerHTML = MENU.map(i=>
    `<option value="${i.id}">${i.nombre} - Bs ${i.precio}</option>`).join("");
}

/* -------------------- ventas -------------------- */
async function sell(id){
  const item = MENU.find(x=>x.id==id);
  const qty = Number($("q_"+id).value || 1);
  await sendSale(item, qty);
}

async function sendSale(item, qty, pago="efectivo"){
  if(!API_URL) return toast("API no configurada");
  const form = new URLSearchParams();
  form.append("action","registrar_venta");
  form.append("producto_id", item.id);
  form.append("producto_nombre", item.nombre);
  form.append("cantidad", qty);
  form.append("precio_unitario", item.precio);
  form.append("total", item.precio * qty);
  form.append("pago", pago);

  try{
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: form.toString()
    });
    const j = await res.json();
    if(j.ok || j === "") { // algunos endpoints devuelven vac√≠o
      toast("Venta registrada");
      updateReport();
    } else {
      toast("Error API");
      console.error(j);
    }
  }catch(err){
    console.error(err);
    toast("No se pudo enviar venta");
  }
}

/* -------------------- reporte -------------------- */
async function updateReport(){
  if(!API_URL) return;
  try{
    const dias = $("selectDias").value;
    const r = await fetch(API_URL + `?action=reporte&dias=${dias}`);
    const data = await r.json();
    $("reportInfo").innerText = `Ingresos: Bs ${Number(data.ingresos_totales||0).toFixed(2)}`;
    $("reportTable").innerHTML = "<ul>" + (data.items||[]).map(it=>`<li>${it.nombre}: ${it.cantidad}</li>`).join("") + "</ul>";
  }catch(err){
    console.error(err);
  }
}

/* -------------------- eventos -------------------- */
["search","filtrocategoria","metrica"].forEach(id => {
  const el = $(id);
  if(el) el.addEventListener("input", renderMenu);
});

$("btnRefrescar")?.addEventListener("click", renderMenu);

$("guardarApi")?.addEventListener("click", ()=>{
  API_URL = $("apiUrl").value.trim();
  localStorage.setItem("api_url_rest", API_URL);
  toast("API guardada");
  loadMenu();
  updateReport();
});

$("probarApi")?.addEventListener("click", async ()=>{
  try{
    const r = await fetch(API_URL + "?action=menu");
    toast(r.ok ? "API OK" : "No responde");
  }catch(e){
    toast("Error conexi√≥n");
  }
});

$("quickSell")?.addEventListener("click", async ()=>{
  const id = $("quickSelect").value;
  const qty = Number($("quickQty").value || 1);
  const pago = $("quickPago").value || "efectivo";
  const item = MENU.find(x=>x.id==id);
  await sendSale(item, qty, pago);
});

/* -------------------- inicio -------------------- */
(function init(){
  $("apiUrl").value = API_URL;
  if(API_URL) { loadMenu(); updateReport(); }
})();
</script>
</body>
</html>
